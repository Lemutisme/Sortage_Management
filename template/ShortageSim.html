<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShortageSim - Drug Shortage Multi-Agent Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .main-content {
            display: flex;
            gap: 30px;
            min-height: 800px;
        }
        
        .left-panel {
            flex: 0 0 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 90vh;
        }
        
        .right-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .simulation-status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status-idle {
            border-left: 5px solid #95a5a6;
        }
        
        .status-running {
            border-left: 5px solid #f39c12;
            animation: pulse 2s infinite;
        }
        
        .status-completed {
            border-left: 5px solid #27ae60;
        }
        
        .status-error {
            border-left: 5px solid #e74c3c;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .timeline-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-left: 20px;
            animation: slideIn 0.5s ease-out;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -35px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #667eea;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .period-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .period-metrics {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }
        
        .metric {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 500;
        }
        
        .metric.shortage {
            background: #ffe6e6;
            color: #e74c3c;
        }
        
        .metric.supply {
            background: #e6f7ff;
            color: #3498db;
        }
        
        .agent-decisions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .agent-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }
        
        .agent-card.fda {
            border-left-color: #e74c3c;
        }
        
        .agent-card.manufacturer {
            border-left-color: #f39c12;
        }
        
        .agent-card.buyer {
            border-left-color: #27ae60;
        }
        
        .agent-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .agent-decision {
            font-size: 0.85em;
            color: #555;
            margin-bottom: 5px;
        }
        
        .agent-reasoning {
            font-size: 0.8em;
            color: #777;
            font-style: italic;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        .fda-announcement {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .fda-announcement::before {
            content: '📢 ';
            margin-right: 8px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .prompt-editor {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
            min-height: 200px;
            border: none;
            resize: vertical;
        }
        
        .results-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .summary-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .summary-metric {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .summary-metric .value {
            font-Size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .summary-metric .label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .collapsible {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .collapsible::before {
            content: '▶';
            transition: transform 0.3s ease;
        }
        
        .collapsible.open::before {
            transform: rotate(90deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.open {
            max-height: 1000px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #e74c3c;
        }
        
        .notification.warning {
            background: #f39c12;
        }
        
        #chartContainer {
            margin-top: 20px;
            height: 300px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .export-buttons .btn {
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-pills"></i> ShortageSim</h1>
            <p>LLM-based Multi-Agent Simulation for Drug Shortage Management</p>
        </div>
        
        <div class="main-content">
            <!-- Left Panel: Configuration -->
            <div class="left-panel">
                <div class="simulation-status status-idle" id="simulationStatus">
                    <h4>Simulation Status: <span id="statusText">Ready</span></h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="statusDetail">Configure parameters and click run to start</p>
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('config')">Config</button>
                    <button class="tab" onclick="switchTab('prompts')">Prompts</button>
                    <button class="tab" onclick="switchTab('advanced')">Advanced</button>
                </div>
                
                <!-- Configuration Tab -->
                <div class="tab-content active" id="config-tab">
                    <div class="section">
                        <h3><i class="fas fa-cogs"></i> Market Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nManufacturers">Manufacturers</label>
                                <input type="number" id="nManufacturers" value="4" min="2" max="10">
                            </div>
                            <div class="form-group">
                                <label for="nPeriods">Periods</label>
                                <input type="number" id="nPeriods" value="4" min="1" max="12">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="disruptionProb">Disruption Probability</label>
                                <input type="number" id="disruptionProb" value="0.05" min="0" max="1" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="disruptionMagnitude">Disruption Magnitude</label>
                                <input type="number" id="disruptionMagnitude" value="0.2" min="0" max="1" step="0.1">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="forceDisruption">
                                <input type="checkbox" id="forceDisruption" style="width: auto; margin-right: 8px;">
                                Start with forced disruption
                            </label>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3><i class="fas fa-dollar-sign"></i> Economic Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="unitProfit">Unit Profit</label>
                                <input type="number" id="unitProfit" value="1.0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="capacityCost">Capacity Cost</label>
                                <input type="number" id="capacityCost" value="0.5" step="0.1">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="holdingCost">Holding Cost</label>
                                <input type="number" id="holdingCost" value="0.1" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="stockoutPenalty">Stockout Penalty</label>
                                <input type="number" id="stockoutPenalty" value="1.1" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3><i class="fas fa-robot"></i> LLM Configuration</h3>
                        <div class="form-group">
                            <label for="llmModel">Model</label>
                            <select id="llmModel">
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="claude-3-opus">Claude 3 Opus</option>
                                <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="temperature">Temperature</label>
                            <input type="number" id="temperature" value="0.3" min="0" max="2" step="0.1">
                        </div>
                        
                        <div class="form-group">
                            <label for="apiKey">API Key (Optional)</label>
                            <input type="password" id="apiKey" placeholder="Will use mock responses if empty">
                        </div>
                    </div>
                </div>
                
                <!-- Prompts Tab -->
                <div class="tab-content" id="prompts-tab">
                    <div class="section">
                        <h3><i class="fas fa-comments"></i> Agent Prompts</h3>
                        
                        <div class="form-group">
                            <label class="collapsible" onclick="toggleCollapsible(this)">
                                Manufacturer System Prompt
                            </label>
                            <div class="collapsible-content">
                                <textarea class="prompt-editor" id="manufacturerSystemPrompt" placeholder="System prompt for manufacturer agents...">You are a pharmaceutical manufacturer CEO making capacity investment decisions. Your goal is to maximize profit while managing operational risks...</textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="collapsible" onclick="toggleCollapsible(this)">
                                Buyer System Prompt
                            </label>
                            <div class="collapsible-content">
                                <textarea class="prompt-editor" id="buyerSystemPrompt" placeholder="System prompt for buyer agent...">You are a healthcare consortium procurement officer. Your goal is to ensure medication availability while minimizing total costs...</textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="collapsible" onclick="toggleCollapsible(this)">
                                FDA System Prompt
                            </label>
                            <div class="collapsible-content">
                                <textarea class="prompt-editor" id="fdaSystemPrompt" placeholder="System prompt for FDA agent...">You are an FDA regulatory analyst responsible for drug shortage monitoring and public communications...</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Tab -->
                <div class="tab-content" id="advanced-tab">
                    <div class="section">
                        <h3><i class="fas fa-sliders-h"></i> Advanced Settings</h3>
                        
                        <div class="form-group">
                            <label for="maxRetries">Max LLM Retries</label>
                            <input type="number" id="maxRetries" value="3" min="1" max="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="simulationType">Simulation Type</label>
                            <select id="simulationType">
                                <option value="single">Single Run</option>
                                <option value="comparative">Comparative Study</option>
                                <option value="monte_carlo">Monte Carlo (Multiple Runs)</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="monteCarloRuns" style="display: none;">
                            <label for="numRuns">Number of Runs</label>
                            <input type="number" id="numRuns" value="10" min="1" max="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="randomSeed">Random Seed (Optional)</label>
                            <input type="number" id="randomSeed" placeholder="Leave empty for random">
                        </div>
                        
                        <div class="form-group">
                            <label for="logLevel">Log Level</label>
                            <select id="logLevel">
                                <option value="INFO">INFO</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <button class="btn" id="runButton" onclick="runSimulation()">
                        <i class="fas fa-play"></i>
                        <span id="runButtonText">Run Simulation</span>
                    </button>
                    <button class="btn btn-secondary" id="stopButton" onclick="stopSimulation()" disabled>
                        <i class="fas fa-stop"></i>
                        Stop
                    </button>
                    <button class="btn btn-danger" onclick="resetSimulation()">
                        <i class="fas fa-redo"></i>
                        Reset
                    </button>
                </div>
            </div>
            
            <!-- Right Panel: Results -->
            <div class="right-panel">
                <div class="results-summary" id="resultsSummary" style="display: none;">
                    <h3><i class="fas fa-chart-line"></i> Simulation Results</h3>
                    <div class="summary-metrics">
                        <div class="summary-metric">
                            <div class="value" id="peakShortage">-</div>
                            <div class="label">Peak Shortage</div>
                        </div>
                        <div class="summary-metric">
                            <div class="value" id="totalCost">-</div>
                            <div class="label">Total Cost</div>
                        </div>
                        <div class="summary-metric">
                            <div class="value" id="resolutionTime">-</div>
                            <div class="label">Resolution Time</div>
                        </div>
                        <div class="summary-metric">
                            <div class="value" id="fdaInterventions">-</div>
                            <div class="label">FDA Interventions</div>
                        </div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="exportResults('json')">
                            <i class="fas fa-download"></i> Export JSON
                        </button>
                        <button class="btn btn-secondary" onclick="exportResults('csv')">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <button class="btn btn-secondary" onclick="generateReport()">
                            <i class="fas fa-file-pdf"></i> Generate Report
                        </button>
                    </div>
                </div>
                
                <div id="chartContainer">
                    <canvas id="resultsChart"></canvas>
                </div>
                
                <div class="timeline-container">
                    <h3><i class="fas fa-clock"></i> Simulation Timeline</h3>
                    <div class="timeline" id="timeline">
                        <div class="timeline-item">
                            <div class="period-header">
                                <div class="period-number">Waiting to start...</div>
                            </div>
                            <p>Configure your simulation parameters and click "Run Simulation" to begin.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>
    
    <script>
        // Global variables
        let simulationRunning = false;
        let currentPeriod = 0;
        let simulationResults = null;
        let resultsChart = null;
        let socket = null;
        
        // Initialize socket connection (for real-time updates)
        function initializeSocket() {
            // This would connect to your backend WebSocket
            // socket = io('ws://localhost:8000');
            
            // Mock socket for demonstration
            socket = {
                emit: (event, data) => console.log('Socket emit:', event, data),
                on: (event, callback) => console.log('Socket on:', event)
            };
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // Collapsible functionality
        function toggleCollapsible(element) {
            element.classList.toggle('open');
            const content = element.nextElementSibling;
            content.classList.toggle('open');
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        // Update simulation status
        function updateStatus(status, detail, progress = 0) {
            const statusElement = document.getElementById('simulationStatus');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            const progressFill = document.getElementById('progressFill');
            
            // Update status class
            statusElement.className = `simulation-status status-${status}`;
            
            // Update text
            statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusDetail.textContent = detail;
            
            // Update progress
            progressFill.style.width = progress + '%';
        }
        
        // Collect configuration from form
        function getConfiguration() {
            const config = {
                n_manufacturers: parseInt(document.getElementById('nManufacturers').value),
                n_periods: parseInt(document.getElementById('nPeriods').value),
                disruption_probability: parseFloat(document.getElementById('disruptionProb').value),
                disruption_magnitude: parseFloat(document.getElementById('disruptionMagnitude').value),
                force_disruption: document.getElementById('forceDisruption').checked,
                unit_profit: parseFloat(document.getElementById('unitProfit').value),
                capacity_cost: parseFloat(document.getElementById('capacityCost').value),
                holding_cost: parseFloat(document.getElementById('holdingCost').value),
                stockout_penalty: parseFloat(document.getElementById('stockoutPenalty').value),
                llm_model: document.getElementById('llmModel').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                api_key: document.getElementById('apiKey').value || null,
                max_retries: parseInt(document.getElementById('maxRetries').value),
                simulation_type: document.getElementById('simulationType').value,
                num_runs: parseInt(document.getElementById('numRuns').value) || 1,
                random_seed: parseInt(document.getElementById('randomSeed').value) || null,
                log_level: document.getElementById('logLevel').value,
                prompts: {
                    manufacturer_system: document.getElementById('manufacturerSystemPrompt').value,
                    buyer_system: document.getElementById('buyerSystemPrompt').value,
                    fda_system: document.getElementById('fdaSystemPrompt').value
                }
            };
            
            return config;
        }
        
        // Run simulation
        async function runSimulation() {
            if (simulationRunning) return;
            
            simulationRunning = true;
            currentPeriod = 0;
            
            // Update UI
            document.getElementById('runButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            document.getElementById('runButtonText').innerHTML = '<div class="loading-spinner"></div> Running...';
            
            // Clear timeline
            document.getElementById('timeline').innerHTML = '';
            
            // Get configuration
            const config = getConfiguration();
            
            try {
                updateStatus('running', 'Initializing simulation...', 0);
                
                // This would be replaced with actual API call to your backend
                await mockSimulationRun(config);
                
                updateStatus('completed', 'Simulation completed successfully!', 100);
                showNotification('Simulation completed successfully!');
                
            } catch (error) {
                updateStatus('error', 'Simulation failed: ' + error.message, 0);
                showNotification('Simulation failed: ' + error.message, 'error');
            } finally {
                simulationRunning = false;
                document.getElementById('runButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
                document.getElementById('runButtonText').innerHTML = '<i class="fas fa-play"></i> Run Simulation';
            }
        }
        
        // Mock simulation run (replace with actual backend integration)
        async function mockSimulationRun(config) {
            const totalPeriods = config.n_periods;
            
            for (let period = 0; period < totalPeriods; period++) {
                currentPeriod = period;
                const progress = ((period + 1) / totalPeriods) * 100;
                
                updateStatus('running', `Running Period ${period + 1}/${totalPeriods}...`, progress);
                
                // Simulate period processing
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Add timeline item
                addTimelineItem(period, generateMockPeriodData(period, config));
                
                // Update chart
                updateChart(period);
            }
            
            // Generate final results
            simulationResults = generateMockResults(config);
            displayFinalResults();
        }
        
        // Generate mock period data
        function generateMockPeriodData(period, config) {
            const shortage = Math.max(0, 0.3 - period * 0.08 + (Math.random() - 0.5) * 0.1);
            const supply = 1.0 - shortage;
            const demand = 1.0 + (period === 0 ? 0.2 : 0) - period * 0.02; // Initial panic buying
            
            return {
                period: period,
                total_demand: demand,
                total_supply: supply,
                shortage_amount: shortage,
                shortage_percentage: shortage / demand,
                disrupted_manufacturers: period < 2 ? [0] : [],
                fda_announcement: period === 0 ? "The FDA is monitoring emerging supply disruptions and encourages manufacturer reporting." : "",
                agent_decisions: {
                    manufacturers: config.n_manufacturers === 2 ? 
                        [
                            { id: 0, investment: period < 2 ? 0 : 0.1, reasoning: "Conservative approach due to disruption" },
                            { id: 1, investment: period === 1 ? 0.15 : 0, reasoning: "Capitalizing on competitor disruption" }
                        ] :
                        Array.from({length: config.n_manufacturers}, (_, i) => ({
                            id: i,
                            investment: Math.random() * 0.2,
                            reasoning: `Manufacturer ${i} investment decision based on market conditions`
                        })),
                    buyer: {
                        demand_quantity: demand,
                        reasoning: period === 0 ? "Stockpiling due to FDA alert" : "Normalizing demand"
                    },
                    fda: {
                        announcement_type: period === 0 ? "alert" : "none",
                        reasoning: period === 0 ? "Alerting market to supply disruption" : "Monitoring situation"
                    }
                }
            };
        }
        
        // Add timeline item
        function addTimelineItem(period, data) {
            const timeline = document.getElementById('timeline');
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            
            const shortageClass = data.shortage_percentage > 0.1 ? 'shortage' : 'supply';
            
            timelineItem.innerHTML = `
                <div class="period-header">
                    <div class="period-number">Period ${period + 1}</div>
                    <div class="period-metrics">
                        <div class="metric ${shortageClass}">
                            Shortage: ${(data.shortage_percentage * 100).toFixed(1)}%
                        </div>
                        <div class="metric supply">
                            Supply: ${data.total_supply.toFixed(2)}
                        </div>
                        <div class="metric">
                            Demand: ${data.total_demand.toFixed(2)}
                        </div>
                    </div>
                </div>
                
                ${data.fda_announcement ? `<div class="fda-announcement">${data.fda_announcement}</div>` : ''}
                
                <div class="agent-decisions">
                    <div class="agent-card fda">
                        <div class="agent-title">🏛️ FDA Regulator</div>
                        <div class="agent-decision">
                            <strong>Decision:</strong> ${data.agent_decisions.fda.announcement_type}
                        </div>
                        <div class="agent-reasoning">
                            "${data.agent_decisions.fda.reasoning}"
                        </div>
                    </div>
                    
                    <div class="agent-card manufacturer">
                        <div class="agent-title">🏭 Manufacturers</div>
                        ${data.agent_decisions.manufacturers.slice(0, 2).map(mfr => `
                            <div class="agent-decision">
                                <strong>Mfr ${mfr.id}:</strong> ${(mfr.investment * 100).toFixed(0)}% investment
                            </div>
                        `).join('')}
                        <div class="agent-reasoning">
                            "${data.agent_decisions.manufacturers[0].reasoning}"
                        </div>
                    </div>
                    
                    <div class="agent-card buyer">
                        <div class="agent-title">🏥 Healthcare Buyers</div>
                        <div class="agent-decision">
                            <strong>Order:</strong> ${data.agent_decisions.buyer.demand_quantity.toFixed(2)} units
                        </div>
                        <div class="agent-reasoning">
                            "${data.agent_decisions.buyer.reasoning}"
                        </div>
                    </div>
                </div>
            `;
            
            timeline.appendChild(timelineItem);
            timeline.scrollTop = timeline.scrollHeight;
        }
        
        // Update chart
        function updateChart(period) {
            if (!resultsChart) {
                const ctx = document.getElementById('resultsChart').getContext('2d');
                resultsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Supply',
                                data: [],
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                fill: true
                            },
                            {
                                label: 'Demand',
                                data: [],
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                fill: false
                            },
                            {
                                label: 'Shortage %',
                                data: [],
                                borderColor: '#f39c12',
                                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantity'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Shortage %'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            },
                            title: {
                                display: true,
                                text: 'Supply Chain Dynamics Over Time'
                            }
                        }
                    }
                });
            }
            
            // Update chart data (mock data for now)
            const shortage = Math.max(0, 0.3 - period * 0.08);
            const supply = 1.0 - shortage;
            const demand = 1.0 + (period === 0 ? 0.2 : 0) - period * 0.02;
            
            resultsChart.data.labels.push(`Period ${period + 1}`);
            resultsChart.data.datasets[0].data.push(supply);
            resultsChart.data.datasets[1].data.push(demand);
            resultsChart.data.datasets[2].data.push(shortage * 100);
            
            resultsChart.update();
        }
        
        // Generate mock results
        function generateMockResults(config) {
            return {
                summary_metrics: {
                    peak_shortage_percentage: 0.30,
                    total_shortage_periods: 2,
                    average_shortage_percentage: 0.12,
                    time_to_resolution: 3,
                    total_manufacturer_profit: 12.5,
                    total_invested_amount: 0.8,
                    buyer_cost_efficiency: 0.85,
                    fda_intervention_rate: 0.25
                },
                buyer_total_cost: 8.2,
                fda_announcements: 1,
                logging_session: {
                    simulation_id: 'sim_' + Date.now(),
                    total_events: 156,
                    decision_events: 28
                }
            };
        }
        
        // Display final results
        function displayFinalResults() {
            if (!simulationResults) return;
            
            const metrics = simulationResults.summary_metrics;
            
            // Update summary metrics
            document.getElementById('peakShortage').textContent = (metrics.peak_shortage_percentage * 100).toFixed(1) + '%';
            document.getElementById('totalCost').textContent = simulationResults.buyer_total_cost.toFixed(1);
            document.getElementById('resolutionTime').textContent = metrics.time_to_resolution + ' periods';
            document.getElementById('fdaInterventions').textContent = simulationResults.fda_announcements;
            
            // Show results summary
            document.getElementById('resultsSummary').style.display = 'block';
        }
        
        // Stop simulation
        function stopSimulation() {
            if (!simulationRunning) return;
            
            simulationRunning = false;
            updateStatus('idle', 'Simulation stopped by user', 0);
            showNotification('Simulation stopped', 'warning');
            
            // Reset UI
            document.getElementById('runButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            document.getElementById('runButtonText').innerHTML = '<i class="fas fa-play"></i> Run Simulation';
        }
        
        // Reset simulation
        function resetSimulation() {
            stopSimulation();
            
            // Clear timeline
            document.getElementById('timeline').innerHTML = `
                <div class="timeline-item">
                    <div class="period-header">
                        <div class="period-number">Waiting to start...</div>
                    </div>
                    <p>Configure your simulation parameters and click "Run Simulation" to begin.</p>
                </div>
            `;
            
            // Clear chart
            if (resultsChart) {
                resultsChart.destroy();
                resultsChart = null;
            }
            
            // Hide results
            document.getElementById('resultsSummary').style.display = 'none';
            
            currentPeriod = 0;
            simulationResults = null;
            
            updateStatus('idle', 'Ready to run simulation', 0);
            showNotification('Simulation reset');
        }
        
        // Export results
        function exportResults(format) {
            if (!simulationResults) {
                showNotification('No results to export', 'warning');
                return;
            }
            
            let data, filename, mimeType;
            
            if (format === 'json') {
                data = JSON.stringify(simulationResults, null, 2);
                filename = `shortagesim_results_${Date.now()}.json`;
                mimeType = 'application/json';
            } else if (format === 'csv') {
                // Convert to CSV format
                data = convertToCSV(simulationResults);
                filename = `shortagesim_results_${Date.now()}.csv`;
                mimeType = 'text/csv';
            }
            
            // Create download link
            const blob = new Blob([data], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`Results exported as ${format.toUpperCase()}`);
        }
        
        // Convert results to CSV
        function convertToCSV(results) {
            const metrics = results.summary_metrics;
            const csv = [
                'Metric,Value',
                `Peak Shortage Percentage,${metrics.peak_shortage_percentage}`,
                `Total Shortage Periods,${metrics.total_shortage_periods}`,
                `Average Shortage Percentage,${metrics.average_shortage_percentage}`,
                `Time to Resolution,${metrics.time_to_resolution}`,
                `Total Manufacturer Profit,${metrics.total_manufacturer_profit}`,
                `Buyer Total Cost,${results.buyer_total_cost}`,
                `FDA Interventions,${results.fda_announcements}`
            ].join('\n');
            
            return csv;
        }
        
        // Generate report
        function generateReport() {
            showNotification('Report generation would be implemented here', 'warning');
        }
        
        // Event listeners
        document.getElementById('simulationType').addEventListener('change', function() {
            const monteCarloRuns = document.getElementById('monteCarloRuns');
            if (this.value === 'monte_carlo') {
                monteCarloRuns.style.display = 'block';
            } else {
                monteCarloRuns.style.display = 'none';
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            updateStatus('idle', 'Ready to run simulation', 0);
            
            // Load default prompts
            document.getElementById('manufacturerSystemPrompt').value = 'You are a pharmaceutical manufacturer CEO making capacity investment decisions. Your goal is to maximize profit while managing operational risks and responding to market signals from the FDA and competitors.';
            document.getElementById('buyerSystemPrompt').value = 'You are a healthcare consortium procurement officer. Your goal is to ensure medication availability while minimizing total costs including purchase price, holding costs, and stockout penalties.';
            document.getElementById('fdaSystemPrompt').value = 'You are an FDA regulatory analyst responsible for drug shortage monitoring and public communications. Your goal is to minimize shortage duration and severity through effective market coordination.';
        });
    </script>
</body>
</html>